<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem POS Resto Terintegrasi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --dark: #0f172a; --bg: #f8fafc; --success: #10b981; --orange: #f59e0b; --danger: #ef4444; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--dark); padding-bottom: 30px; }
        
        /* Navbar */
        .nav-bar { background: var(--dark); display: none; flex-wrap: wrap; justify-content: center; padding: 10px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .nav-bar button { background: transparent; color: #94a3b8; border: none; padding: 12px 18px; margin: 2px; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .nav-bar button.active { background: var(--primary); color: white; }
        .nav-bar button:hover:not(.active) { color: white; background: rgba(255,255,255,0.1); }

        /* Container */
        .view { display: none; padding: 20px; max-width: 1100px; margin: auto; animation: slideUp 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; font-size: 1.5rem; color: var(--dark); }

        /* Menu Grid */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .menu-item { border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; background: white; position: relative; transition: all 0.2s; }
        .menu-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37,99,235,0.1); }
        .menu-item.out { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
        .stok-badge { background: var(--orange); color: white; padding: 2px 8px; border-radius: 20px; font-size: 10px; position: absolute; top: 8px; right: 8px; font-weight: 700; }

        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 16px; }

        /* Table */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f1f5f9; color: #64748b; font-weight: 600; text-align: left; padding: 12px; font-size: 13px; }
        td { padding: 12px; border-top: 1px solid #e2e8f0; font-size: 14px; }

        /* Struk */
        #receipt { font-family: 'Courier New', monospace; padding: 25px; border: 1px dashed #cbd5e1; background: #fff; max-width: 320px; margin: 20px auto; color: #000; }
    </style>
</head>
<body>

    <div id="view-home" class="view active">
        <div style="max-width:380px; margin: 100px auto; text-align:center;" class="card">
            <h1 style="color: var(--primary); margin-bottom: 10px;">POS RESTO</h1>
            <p style="color: #64748b;">Silakan masukkan PIN akses</p>
            <input type="password" id="pass-input" placeholder="PIN Keamanan" style="text-align: center; letter-spacing: 5px;">
            <label style="display: flex; align-items: center; justify-content: center; gap: 8px; margin: 15px 0; font-size: 14px; color: #475569; cursor: pointer;">
                <input type="checkbox" id="remember-me"> Ingat perangkat ini
            </label>
            <button class="btn btn-primary" onclick="handleLogin()">MASUK SISTEM</button>
        </div>
    </div>

    <div class="nav-bar" id="main-nav">
        <button id="btn-waiter" onclick="switchView('waiter')">WAITER</button>
        <button id="btn-dapur" onclick="switchView('dapur')">DAPUR</button>
        <button id="btn-kasir" onclick="switchView('kasir')">KASIR</button>
        <button id="btn-stok" onclick="switchView('stok')">GUDANG</button>
        <button id="btn-laporan" onclick="switchView('laporan')">LAPORAN</button>
        <button onclick="logout()" style="color: #fb7185;">LOGOUT</button>
    </div>

    <div id="view-waiter" class="view">
        <div class="card">
            <h2>Input Pesanan Baru</h2>
            <input type="number" id="meja-input" placeholder="Nomor Meja (Contoh: 05)">
            <div class="menu-grid" id="menu-container"></div>
        </div>
        <div class="card" id="cart-card" style="display: none; border-left: 5px solid var(--primary);">
            <h4 style="margin: 0 0 10px 0;">Item Terpilih:</h4>
            <div id="cart-display" style="font-size: 14px; margin-bottom: 15px; color: #334155;"></div>
            <button class="btn btn-primary" onclick="kirimPesanan()">KIRIM PESANAN KE DAPUR</button>
        </div>
    </div>

    <div id="view-dapur" class="view">
        <h2>Antrean Masak (Dapur)</h2>
        <div id="dapur-container" class="menu-grid"></div>
    </div>

    <div id="view-kasir" class="view">
        <h2>Billing & Kasir</h2>
        <div id="kasir-container"></div>
        <div id="receipt-area" style="display:none; text-align: center;">
            <div id="receipt"></div>
            <button class="btn btn-primary" style="width: auto; padding: 12px 30px;" onclick="window.print()">PRINT STRUK</button>
            <button class="btn" style="width: auto; padding: 12px 30px;" onclick="closeReceipt()">TUTUP</button>
        </div>
    </div>

    <div id="view-stok" class="view">
        <h2>Manajemen Stok</h2>
        <div class="card" id="stok-container"></div>
    </div>

    <div id="view-laporan" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h2 style="margin:0">Laporan Penjualan</h2>
            <button onclick="resetLaporan()" class="btn-danger" style="width:auto; padding:8px 20px; font-size: 12px;">RESET LAPORAN</button>
        </div>
        <div class="card">
            <h3 id="lap-omzet" style="color: var(--success); font-size: 24px; margin-top: 0;">Total Omzet: Rp 0</h3>
            <div class="table-container">
                <table id="lap-table">
                    <thead><tr><th>WAKTU</th><th>MEJA</th><th>PESANAN</th><th>TOTAL</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD8-Ps6ompRiQ7ITKE9nYvOxzR77aL120U",
            authDomain: "kasir-abc5f.firebaseapp.com",
            databaseURL: "https://kasir-abc5f-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "kasir-abc5f",
            storageBucket: "kasir-abc5f.firebasestorage.app",
            messagingSenderId: "442202046937",
            appId: "1:442202046937:web:f55a5871ac7cfbb91159c8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- MASTER DATA MENU ---
        const MASTER_MENU = {
            "m1": { n: "Nasi Goreng Spesial", h: 25000 },
            "m2": { n: "Ayam Bakar Madu", h: 28000 },
            "m3": { n: "Mie Goreng Jawa", h: 20000 },
            "m4": { n: "Es Jeruk Peras", h: 10000 },
            "m5": { n: "Es Teh Manis", h: 5000 },
            "m6": { n: "Kopi Hitam", h: 8000 }
        };

        let cart = [];
        let currentStok = {};

        // --- AUTH ---
        function handleLogin() {
            if(document.getElementById('pass-input').value === "1234") {
                if(document.getElementById('remember-me').checked) localStorage.setItem('pos_logged', 'true');
                showApp();
            } else { alert("PIN Salah!"); }
        }
        window.onload = () => { if(localStorage.getItem('pos_logged') === 'true') showApp(); };
        function showApp() { 
            document.getElementById('view-home').style.display='none'; 
            document.getElementById('main-nav').style.display='flex'; 
            switchView('waiter');
        }
        function logout() { localStorage.removeItem('pos_logged'); location.reload(); }
        
        function switchView(v) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-bar button').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.getElementById('btn-'+v).classList.add('active');
        }

        // --- STOK & MENU ---
        db.ref('stok').on('value', snap => {
            currentStok = snap.val() || { m1:50, m2:50, m3:50, m4:50, m5:50, m6:50 };
            renderMenu(); renderStok();
        });

        function renderMenu() {
            let h = "";
            for(let k in MASTER_MENU) {
                let out = currentStok[k] <= 0 ? "out" : "";
                h += `<div class="menu-item ${out}" onclick="addCart('${k}')">
                        <span class="stok-badge">Stok: ${currentStok[k]}</span>
                        <div style="font-weight:700; margin-bottom:5px;">${MASTER_MENU[k].n}</div>
                        <div style="color:var(--primary); font-size:12px;">Rp ${MASTER_MENU[k].h.toLocaleString()}</div>
                      </div>`;
            }
            document.getElementById('menu-container').innerHTML = h;
        }

        function addCart(k) {
            if(currentStok[k] <= 0) return alert("Stok habis!");
            cart.push({ id: k, ...MASTER_MENU[k] });
            document.getElementById('cart-card').style.display = 'block';
            document.getElementById('cart-display').innerHTML = cart.map(i => `â€¢ ${i.n}`).join("<br>");
        }

        // --- TRANSAKSI ---
        function kirimPesanan() {
            let meja = document.getElementById('meja-input').value;
            if(!meja || cart.length === 0) return alert("Pilih meja & menu!");

            const data = {
                meja, 
                items: cart, 
                total: cart.reduce((s, i) => s + i.h, 0),
                waktu: new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })
            };

            // Potong Stok
            cart.forEach(i => db.ref('stok/'+i.id).set(currentStok[i.id] - 1));

            // Simpan ke 2 jalur paralel
            const ref = db.ref('kasir_aktif').push(data);
            db.ref('dapur_aktif/'+ref.key).set(data);

            alert("Pesanan terkirim!");
            cart = []; 
            document.getElementById('meja-input').value = ""; 
            document.getElementById('cart-card').style.display = 'none';
        }

        // --- REALTIME DAPUR & KASIR ---
        db.ref('dapur_aktif').on('value', snap => {
            let h = ""; const d = snap.val();
            if(d) Object.keys(d).forEach(k => {
                h += `<div class="card" style="border-top:5px solid var(--orange)">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="font-weight:800; font-size:18px;">MEJA ${d[k].meja}</span>
                        </div>
                        <div style="font-size:15px; line-height:1.6; color:#334155;">
                            ${d[k].items.map(i => "<b>-</b> " + i.n).join("<br>")}
                        </div>
                        <button class="btn btn-success" style="margin-top:15px;" onclick="db.ref('dapur_aktif/${k}').remove()">PESANAN SIAP</button>
                      </div>`;
            });
            document.getElementById('dapur-container').innerHTML = h || "<p style='text-align:center; color:#64748b;'>Belum ada pesanan masuk.</p>";
        });

        db.ref('kasir_aktif').on('value', snap => {
            let h = ""; const d = snap.val();
            if(d) Object.keys(d).forEach(k => {
                h += `<div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b>MEJA ${d[k].meja}</b>
                            <b style="color:var(--primary)">Rp ${d[k].total.toLocaleString()}</b>
                        </div>
                        <p style="font-size:12px; color:#64748b; margin: 10px 0;">${d[k].items.map(i => i.n).join(", ")}</p>
                        <button class="btn btn-primary" onclick="prosesBayar('${k}')">BAYAR SEKARANG</button>
                      </div>`;
            });
            document.getElementById('kasir-container').innerHTML = h || "<p style='text-align:center; color:#64748b;'>Tidak ada billing aktif.</p>";
        });

        function prosesBayar(k) {
            db.ref('kasir_aktif/'+k).once('value', snap => {
                const data = snap.val();
                if(!data) return;

                // 1. Simpan ke Laporan
                db.ref('laporan').push(data).then(() => {
                    // 2. Hapus dari Kasir Aktif
                    db.ref('kasir_aktif/'+k).remove();
                    
                    // 3. Render Struk
                    let s = `<div style="text-align:center;"><b>STRUK PEMBAYARAN</b><br>RESTO POS DIGITAL<br>--------------------------</div><br>`;
                    s += `Waktu : ${data.waktu}<br>Meja  : ${data.meja}<br>--------------------------<br>`;
                    data.items.forEach(i => s += `<div style="display:flex; justify-content:space-between"><span>${i.n}</span><span>${i.h}</span></div>`);
                    s += `--------------------------<br><div style="display:flex; justify-content:space-between"><b>TOTAL</b><b>Rp ${data.total.toLocaleString()}</b></div><br>`;
                    s += `<div style="text-align:center;">Terima Kasih Atas Kunjungannya!</div>`;
                    
                    document.getElementById('receipt').innerHTML = s;
                    document.getElementById('receipt-area').style.display='block';
                    document.getElementById('kasir-container').style.display='none';
                });
            });
        }
        function closeReceipt() { 
            document.getElementById('receipt-area').style.display='none'; 
            document.getElementById('kasir-container').style.display='block'; 
        }

        // --- STOK & LAPORAN ---
        function renderStok() {
            let h = "<table><tr><th>NAMA MENU</th><th>STOK</th><th>AKSI</th></tr>";
            for(let k in MASTER_MENU) {
                h += `<tr><td>${MASTER_MENU[k].n}</td><td><b>${currentStok[k]}</b></td>
                      <td><button class="btn btn-primary" style="padding:5px 10px; width:auto;" onclick="updateStok('${k}')">UPDATE</button></td></tr>`;
            }
            document.getElementById('stok-container').innerHTML = h + "</table>";
        }
        function updateStok(k) {
            let v = prompt("Masukkan jumlah stok baru untuk " + MASTER_MENU[k].n + ":");
            if(v !== null && v !== "") db.ref('stok/'+k).set(parseInt(v));
        }

        // REALTIME LAPORAN (Fix Sinkronisasi)
        db.ref('laporan').on('value', snap => {
            const data = snap.val(); 
            const tbody = document.querySelector('#lap-table tbody');
            let h = "", totalOmzet = 0;
            
            if(data) {
                Object.keys(data).reverse().forEach(id => {
                    const l = data[id];
                    totalOmzet += l.total;
                    h += `<tr>
                            <td>${l.waktu}</td>
                            <td>Meja ${l.meja}</td>
                            <td>${l.items.map(i => i.n).join(", ")}</td>
                            <td>Rp ${l.total.toLocaleString()}</td>
                          </tr>`;
                });
            } else {
                h = "<tr><td colspan='4' style='text-align:center;'>Belum ada transaksi selesai hari ini.</td></tr>";
            }
            tbody.innerHTML = h;
            document.getElementById('lap-omzet').innerText = "Total Omzet: Rp " + totalOmzet.toLocaleString();
        });

        function resetLaporan() {
            if(confirm("Hapus semua data laporan penjualan? (Tindakan ini tidak bisa dibatalkan)")) {
                const pin = prompt("Konfirmasi PIN Admin:");
                if(pin === "1234") db.ref('laporan').remove(); else alert("PIN Salah!");
            }
        }
    </script>
</body>
</html>
