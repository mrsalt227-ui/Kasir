<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS RESTO PRO - v4.7</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; --primary-hover: #4338ca;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --dark: #1e293b; --light-bg: #f1f5f9; --card-bg: #ffffff;
        }
        
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.2s ease; }
        body { margin: 0; background: var(--light-bg); color: var(--dark); overflow-x: hidden; }

        /* Navigasi Modern */
        .nav-bar { 
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            display: none; justify-content: center; padding: 12px; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .nav-bar button { 
            background: transparent; color: #94a3b8; border: none; padding: 10px 18px; 
            margin: 0 4px; cursor: pointer; border-radius: 10px; font-weight: 600; font-size: 13px; 
        }
        .nav-bar button.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* Views */
        .view { display: none; padding: 25px; max-width: 1100px; margin: auto; opacity: 0; transform: translateY(10px); }
        .view.active { display: block; opacity: 1; transform: translateY(0); }

        /* Modern Cards */
        .card { 
            background: var(--card-bg); padding: 24px; border-radius: 16px; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid rgba(226, 232, 240, 0.8);
        }
        h3 { margin-top: 0; color: var(--dark); font-weight: 700; display: flex; align-items: center; gap: 8px; }

        /* Grid Menu & Stok Real-time */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; }
        .menu-item { 
            background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 20px; 
            text-align: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .menu-item:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 12px 20px rgba(0,0,0,0.08); }
        .menu-item:active { transform: scale(0.95); }
        
        .stock-indicator { 
            position: absolute; top: 10px; right: 10px; padding: 4px 8px; 
            border-radius: 8px; font-size: 10px; font-weight: 700; 
        }
        .stock-safe { background: #dcfce7; color: var(--success); }
        .stock-low { background: #fef3c7; color: var(--warning); }
        .stock-empty { background: #fee2e2; color: var(--danger); }

        /* Cart Floating */
        #cart-box { border-left: 5px solid var(--primary); position: relative; background: #f8faff; }
        .cart-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 12px 16px; border-radius: 12px; margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        /* Buttons & Inputs */
        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 12px; 
            font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); color: white; }
        
        input { 
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; 
            margin: 10px 0; font-size: 15px; outline: none; 
        }
        input:focus { border-color: var(--primary); }

        /* Table Laporan */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #64748b; }
        td { padding: 15px; border-top: 1px solid #f1f5f9; }

        @media (max-width: 600px) { .menu-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

    <div id="view-home" class="view active">
        <div style="max-width:400px; margin: 120px auto; text-align:center;" class="card">
            <div style="font-size: 40px; margin-bottom: 10px;">üçΩÔ∏è</div>
            <h2 style="margin:0; letter-spacing: -1px;">Welcome Back</h2>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">Enter your PIN to access the system</p>
            <input type="password" id="pass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align:center; letter-spacing: 10px; font-size: 24px;">
            <button class="btn btn-primary" onclick="handleLogin()">Unlock System</button>
        </div>
    </div>

    <div class="nav-bar" id="main-nav">
        <button id="nav-waiter" onclick="switchView('waiter')">üì¶ ORDER</button>
        <button id="nav-antar" onclick="switchView('antar')">üöö ANTAR</button>
        <button id="nav-dapur" onclick="switchView('dapur')">üç≥ DAPUR</button>
        <button id="nav-kasir" onclick="switchView('kasir')">üíµ KASIR</button>
        <button id="nav-stok" onclick="switchView('stok')">üè¨ GUDANG</button>
        <button id="nav-laporan" onclick="switchView('laporan')">üìà LAPORAN</button>
        <button onclick="location.reload()" style="color: var(--danger); margin-left: auto;">LOGOUT</button>
    </div>

    <div id="view-waiter" class="view">
        <div class="card">
            <h3><span style="font-size:20px;">üìù</span> New Order</h3>
            <input type="number" id="meja-input" placeholder="Nomor Meja Pelanggan...">
            <div class="menu-grid" id="menu-container"></div>
        </div>
        
        <div id="cart-box" style="display:none;" class="card">
            <h3>üõí Cart Meja <span id="display-meja"></span></h3>
            <div id="cart-list"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" style="background:#e2e8f0; color:var(--dark);" onclick="cancelSemua()">Clear</button>
                <button class="btn btn-primary" onclick="kirimPesanan()">Confirm Order</button>
            </div>
        </div>
    </div>

    <div id="view-dapur" class="view"><h3>üç≥ Kitchen Queue</h3><div id="dapur-container"></div></div>
    <div id="view-antar" class="view"><h3>üöö Ready to Serve</h3><div id="antar-container" class="menu-grid"></div></div>
    <div id="view-kasir" class="view"><h3>üíµ Billing</h3><div id="kasir-container"></div></div>

    <div id="view-stok" class="view">
        <div class="card owner-only"><h3>üè∑Ô∏è Price & Master</h3><div id="price-control-area"></div></div>
        <div class="card owner-only">
            <h3>üì• Stock Entry</h3>
            <select id="stok-item-select"></select>
            <input type="number" id="stok-qty-input" placeholder="Add quantity...">
            <button class="btn btn-primary" onclick="tambahStokBatch()">Add to Batch</button>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between;"><h3>üì¶ Live Inventory</h3><button class="owner-only btn-danger" style="width:auto; padding:5px 15px;" onclick="resetGudang()">Reset</button></div>
            <div id="stok-list-area"></div>
        </div>
    </div>

    <div id="view-laporan" class="view">
        <div class="card" style="background: var(--primary); color:white;">
            <p style="margin:0; opacity:0.8;">Total Revenue</p>
            <h1 id="lap-omzet" style="margin:5px 0 0 0; font-size:40px;">Rp 0</h1>
        </div>
        <div class="card"><h3>üìä Sales History</h3><table id="lap-body"></table></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase Config (Tetap sama agar koneksi tidak putus)
        const firebaseConfig = {
            apiKey: "AIzaSyD8-Ps6ompRiQ7ITKE9nYvOxzR77aL120U",
            authDomain: "kasir-abc5f.firebaseapp.com",
            databaseURL: "https://kasir-abc5f-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "kasir-abc5f",
            storageBucket: "kasir-abc5f.firebasestorage.app",
            messagingSenderId: "442202046937",
            appId: "1:442202046937:web:f55a5871ac7cfbb91159c8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let MASTER_MENU = {};
        let cart = [];
        let stokFIFO = {};

        // --- AUTH ---
        function handleLogin() {
            const pin = document.getElementById('pass-input').value;
            const btns = document.querySelectorAll('.nav-bar button');
            btns.forEach(b => b.style.display = 'none');
            btns[btns.length-1].style.display = 'block';
            document.querySelectorAll('.owner-only').forEach(el => el.style.display = 'none');

            if(pin === "1111") { 
                document.getElementById('nav-waiter').style.display = 'block';
                document.getElementById('nav-antar').style.display = 'block';
                switchView('waiter');
            } else if(pin === "4444") { 
                btns.forEach(b => b.style.display = 'block');
                document.querySelectorAll('.owner-only').forEach(el => el.style.display = 'block');
                switchView('laporan');
            } else { alert("Wrong PIN!"); return; }
            document.getElementById('view-home').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
        }

        function switchView(v) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-bar button').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            if(document.getElementById('nav-'+v)) document.getElementById('nav-'+v).classList.add('active');
        }

        // --- CORE DATA & REALTIME STOCK ---
        db.ref('master_menu').on('value', snap => { MASTER_MENU = snap.val() || {}; renderMenu(); renderPriceControl(); renderMenuDropdown(); });
        db.ref('stok_fifo').on('value', snap => { stokFIFO = snap.val() || {}; renderMenu(); renderStokGudang(); });

        function renderMenu() {
            let h = "";
            for(let id in MASTER_MENU) {
                let total = 0; 
                if(stokFIFO[id]) Object.values(stokFIFO[id]).forEach(b => total += b.qty);
                
                let stockClass = total > 10 ? 'stock-safe' : (total > 0 ? 'stock-low' : 'stock-empty');
                let stockText = total > 0 ? `Stock: ${total}` : 'OUT OF STOCK';

                h += `
                <div class="menu-item" onclick="${total > 0 ? `addCart('${id}')` : 'alert(\'Stok Habis!\')'}">
                    <span class="stock-indicator ${stockClass}">${stockText}</span>
                    <div style="font-size:30px; margin-bottom:10px;">üç¥</div>
                    <div style="font-weight:700; font-size:14px; margin-bottom:5px;">${MASTER_MENU[id].n}</div>
                    <div style="color:var(--primary); font-weight:700; font-size:13px;">Rp ${MASTER_MENU[id].h.toLocaleString()}</div>
                </div>`;
            }
            document.getElementById('menu-container').innerHTML = h;
        }

        // --- CART LOGIC (v4.6 UPGRADED) ---
        function addCart(id) {
            const existing = cart.find(item => item.id === id);
            // Cek sisa stok di keranjang vs stok asli
            let totalTersedia = 0;
            if(stokFIFO[id]) Object.values(stokFIFO[id]).forEach(b => totalTersedia += b.qty);
            
            if (existing) {
                if(existing.qty + 1 > totalTersedia) return alert("Batas stok tercapai!");
                existing.qty += 1;
            } else {
                cart.push({ id, n: MASTER_MENU[id].n, h: MASTER_MENU[id].h, qty: 1 });
            }
            renderCart();
        }

        function renderCart() {
            const box = document.getElementById('cart-box');
            const list = document.getElementById('cart-list');
            if(cart.length === 0) { box.style.display = 'none'; return; }
            box.style.display = 'block';
            document.getElementById('display-meja').innerText = document.getElementById('meja-input').value || "?";
            list.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div><b>${item.n}</b> <span class="qty-badge" style="background:#eef2ff; color:var(--primary); padding:2px 8px; border-radius:6px; margin-left:10px;">x${item.qty}</span></div>
                    <button onclick="batalSatu('${item.id}')" style="border:none; background:none; color:var(--danger); cursor:pointer; font-weight:bold;">‚úï</button>
                </div>
            `).join("");
        }

        function batalSatu(id) {
            const idx = cart.findIndex(item => item.id === id);
            if (idx > -1) {
                if (cart[idx].qty > 1) cart[idx].qty -= 1;
                else cart.splice(idx, 1);
            }
            renderCart();
        }

        function cancelSemua() { cart = []; renderCart(); }

        // --- ACTION LOGIC ---
        async function kirimPesanan() {
            const meja = document.getElementById('meja-input').value;
            if(!meja) return alert("Pilih nomor meja!");
            
            for(let item of cart) {
                for(let i = 0; i < item.qty; i++) await potongStok(item.id);
            }

            db.ref('orders').push({
                meja, items: cart, total: cart.reduce((s,i) => s + (i.h * i.qty), 0),
                ts: Date.now(), waktu: new Date().toLocaleTimeString(), status: "dimasak"
            });
            cart = []; document.getElementById('meja-input').value = ""; renderCart();
            alert("Sent to Kitchen!");
        }

        async function potongStok(id) {
            const batches = Object.keys(stokFIFO[id]).map(k=>({k, ...stokFIFO[id][k]})).sort((a,b)=>a.ts-b.ts);
            const oldest = batches[0];
            if(oldest.qty > 1) await db.ref(`stok_fifo/${id}/${oldest.k}`).update({ qty: oldest.qty - 1 });
            else await db.ref(`stok_fifo/${id}/${oldest.k}`).remove();
        }

        // --- DASHBOARD REALTIME ---
        db.ref('orders').on('value', snap => {
            const data = snap.val();
            let dH = "", aH = "", kH = "";
            if(data) {
                const arr = Object.keys(data).map(k=>({k, ...data[k]})).sort((a,b)=>a.ts-b.ts);
                arr.forEach(o => {
                    const html = `<div class="card" style="border-left:5px solid ${o.status==='dimasak'?'var(--warning)':'var(--success)'}">
                        <div style="display:flex; justify-content:space-between;"><b>Meja ${o.meja}</b> <small>${o.waktu}</small></div>
                        <p style="margin:10px 0;">${o.items.map(i => `${i.n} (x${i.qty})`).join(", ")}</p>
                        ${o.status==='dimasak' ? `<button class="btn btn-primary" onclick="db.ref('orders/${o.k}/status').set('siap')">MARK AS READY</button>` : ''}
                        ${o.status==='siap' ? `<button class="btn" style="background:var(--success); color:white" onclick="db.ref('orders/${o.k}/status').set('diantar')">DELIVERED</button>` : ''}
                        ${o.status==='diantar' ? `<button class="btn btn-primary" onclick="bayar('${o.k}')">COLLECT Rp${o.total.toLocaleString()}</button>` : ''}
                    </div>`;
                    if(o.status==='dimasak') dH += html; else if(o.status==='siap') aH += html; else if(o.status==='diantar') kH += html;
                });
            }
            document.getElementById('dapur-container').innerHTML = dH;
            document.getElementById('antar-container').innerHTML = aH;
            document.getElementById('kasir-container').innerHTML = kH;
        });

        // --- GUDANG & LAPORAN ---
        function renderStokGudang() {
            let h = "<table><thead><tr><th>Menu Name</th><th>Stock Batches</th></tr></thead><tbody>";
            for(let id in MASTER_MENU) {
                let batches = stokFIFO[id] ? Object.keys(stokFIFO[id]).map(k=>({k, ...stokFIFO[id][k]})).sort((a,b)=>a.ts-b.ts) : [];
                let bHTML = batches.map(b => `<span class="qty-badge" style="background:#f1f5f9; padding:2px 8px; border-radius:6px; margin:2px; display:inline-block">${b.qty}</span>`).join("");
                h += `<tr><td><b>${MASTER_MENU[id].n}</b></td><td>${bHTML || '<span style="color:var(--danger)">Out of stock</span>'}</td></tr>`;
            }
            document.getElementById('stok-list-area').innerHTML = h + "</tbody></table>";
        }

        function bayar(k) {
            db.ref('orders/'+k).once('value', snap => {
                db.ref('laporan').push(snap.val()).then(() => db.ref('orders/'+k).remove());
            });
        }

        db.ref('laporan').on('value', snap => {
            let h = "<thead><tr><th>Time</th><th>Table</th><th>Amount</th></tr></thead><tbody>", t = 0; 
            if(snap.val()) Object.values(snap.val()).reverse().forEach(l=>{
                t+=l.total; h+=`<tr><td>${l.waktu}</td><td>Meja ${l.meja}</td><td><b>Rp ${l.total.toLocaleString()}</b></td></tr>`;
            });
            document.getElementById('lap-body').innerHTML = h + "</tbody>";
            document.getElementById('lap-omzet').innerText = "Rp " + t.toLocaleString();
        });

        function renderPriceControl() {
            let h = "<table>";
            for(let id in MASTER_MENU) h += `<tr><td>${MASTER_MENU[id].n}</td><td><button class="btn" style="padding:5px; background:#f1f5f9" onclick="editHarga('${id}')">Rp ${MASTER_MENU[id].h.toLocaleString()}</button></td></tr>`;
            document.getElementById('price-control-area').innerHTML = h + "</table>";
        }
        function editHarga(id) { let p = prompt("New Price?"); if(p) db.ref(`master_menu/${id}/h`).set(parseInt(p)); }
        function renderMenuDropdown() { let h = ""; for(let id in MASTER_MENU) h += `<option value="${id}">${MASTER_MENU[id].n}</option>`; document.getElementById('stok-item-select').innerHTML = h; }
        function tambahStokBatch() {
            const id = document.getElementById('stok-item-select').value;
            const qty = parseInt(document.getElementById('stok-qty-input').value);
            if(qty) db.ref('stok_fifo/'+id).push({ qty, ts: Date.now(), tgl: new Date().toLocaleDateString() });
            document.getElementById('stok-qty-input').value = "";
        }
        function resetGudang() { if(confirm("Clear all inventory?")) db.ref('stok_fifo').remove(); }
    </script>
</body>
</html>
